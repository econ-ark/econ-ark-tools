\ProvidesPackage{econark-multibib}[2024/06/08 Supports system.bib and filename-Add-Refs.bib]

\RequirePackage{ifthen}
\RequirePackage{etoolbox}

\newcommand{\IfFileExistsAndNotEmpty}[2]{%
  \IfFileExists{#1}%
    {\IsFileEmpty{#1}%
      {\typeout{File #1 exists but is empty}#2}%
      {\typeout{File #1 exists and is not empty}#2}%
    }%
    {\typeout{File #1 does not exist}}%
}

\newread\filetest
\newcommand{\IsFileEmpty}[2]{%
  \openin\filetest=#1
  \ifeof\filetest
    \typeout{File #1 is empty}#2%
  \else
    \closein\filetest
  \fi
}

\newcommand{\econarkmultibib}[1]{%
  \def\filename{#1}%
  \typeout{beginning econarkmultibibmod}
  \provideboolean{AddRefsExists}%
  \provideboolean{systemExists}%
  \provideboolean{filenameExists}%

  \typeout{testing system.bib}%
  \IfFileExistsAndNotEmpty{/usr/local/texlive/texmf-local/bibtex/bib/system.bib}{%
    \setboolean{systemExists}{true}%
    \typeout{econark-multibib: File system.bib found}%
  }{%
    \typeout{cannot be true and false}%
    \setboolean{systemExists}{false}%
    \typeout{econark-multibib: File system.bib not found}%
  }%
  \typeout{testing system.bib end}%
  \typeout{testing Add-Refs.bib}%
  \IfFileExistsAndNotEmpty{\filename-Add-Refs.bib}{%
    \setboolean{AddRefsExists}{true}%
    \typeout{econark-multibib: File \filename-Add-Refs.bib found}%
  }{%
    \setboolean{AddRefsExists}{false}%
    \typeout{econark-multibib: File \filename-Add-Refs.bib not found}%
  }%
  \typeout{testing Add-Refs.bib - end}%
  \typeout{testing \filename.bib}%
  \IfFileExistsAndNotEmpty{\filename.bib}{%
    \setboolean{filenameExists}{true}%
    \typeout{econark-multibib: File \filename.bib found}%
  }{%
    \setboolean{filenameExists}{false}%
    \typeout{econark-multibib: File \filename.bib not found}%
  }%
  \typeout{testing \filename.bib end}%
  
  \ifthenelse{\boolean{AddRefsExists}}{% AddRefs
    \ifthenelse{\boolean{systemExists}}{% Addrefs+system 
      \ifthenelse{\boolean{filenameExists}}{% AddRefs+system+file
        \typeout{econark-multibib: References in \filename-Add-Refs.bib will take precedence over those elsewhere}%
        \typeout{econark-multibib: References in default global system.bib will be used for items not found elsewhere}%
        \bibliography{\filename-Add-Refs,\filename,system}%
      }{% AddRefs+system-file
        \typeout{econark-multibib: References in \filename-Add-Refs.bib will take precedence over those elsewhere}%
        \typeout{econark-multibib: References in default global system.bib will be used for items not found elsewhere}%
        \bibliography{\filename-Add-Refs,system}%
      }%
    }{% +AddRefs-system
      \ifthenelse{\boolean{filenameExists}}{% AddRefs-system+file
        \typeout{econark-multibib: References in \filename-Add-Refs.bib will take precedence over those elsewhere}%
        \typeout{econark-multibib: References in default global system.bib will be used for items not found elsewhere}%
        \bibliography{\filename,\filename-Add-Refs}%
      }{% +AddRefs-system-file
        \typeout{econark-multibib: References in \filename-Add-Refs.bib will be used}%
        \bibliography{\filename-Add-Refs}%
      }% end filename+AddRefs-system
    }%
  }{% -AddRefs
    \ifthenelse{\boolean{systemExists}}{% -AddRefs+system
      \ifthenelse{\boolean{filenameExists}}{% -AddRefs+file+system
        \typeout{econark-multibib: References in default global system.bib will be used for items not found in \filename.bib}%
        \bibliography{\filename,system}%
      }{% -AddRefs+system-file
        \typeout{econark-multibib: References in default global system.bib will be used}%
        \bibliography{system}%
      }% end file
    }{% -AddRefs-system
      \ifthenelse{\boolean{filenameExists}}{%
        \typeout{econark-multibib: references in \filename.bib}%
        \bibliography{\filename}%
      }{% -AddRefs-system-file
        \typeout{econark-multibib: No bibliography files found}%
      }}%
  }%
}%

\endinput
